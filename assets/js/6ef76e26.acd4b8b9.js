"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1634],{8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var i=t(6540);const a={},s=i.createContext(a);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(s.Provider,{value:n},e.children)}},9586:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"custom-rules","title":"Implementing a Custom Rule","description":"Whilst Liquibase Linter has lots of good core rules, you may have a use case that\'s particular to your project and wouldn\'t make sense as a core rule.","source":"@site/docs/custom-rules.md","sourceDirName":".","slug":"/custom-rules","permalink":"/liquibase-linter/docs/custom-rules","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Implementing a Custom Rule"},"sidebar":"docs","previous":{"title":"valid-context","permalink":"/liquibase-linter/docs/rules/valid-context"},"next":{"title":"Using Reporters","permalink":"/liquibase-linter/docs/reporting/"}}');var a=t(4848),s=t(8453);const o={title:"Implementing a Custom Rule"},l=void 0,r={},c=[{value:"Example use case",id:"example-use-case",level:2},{value:"Writing the rule",id:"writing-the-rule",level:2},{value:"Making the rule discoverable",id:"making-the-rule-discoverable",level:2},{value:"Configuring the rule",id:"configuring-the-rule",level:2}];function u(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Whilst Liquibase Linter has lots of good core rules, you may have a use case that's particular to your project and wouldn't make sense as a core rule."}),"\n",(0,a.jsx)(n.p,{children:"Fortunately it's trivial to implement custom rules and apply them in your own project; you just need to write a Java class implementing one of our rule interfaces, and do a little configuration."}),"\n",(0,a.jsx)(n.h2,{id:"example-use-case",children:"Example use case"}),"\n",(0,a.jsxs)(n.p,{children:["Let's say for argument's sake that we have a Liquibase project for an app. We ship customised implementations of this app to different clients, so we have a ",(0,a.jsx)(n.code,{children:"core"})," context and then client-specific contexts like ",(0,a.jsx)(n.code,{children:"client_jane"})," and ",(0,a.jsx)(n.code,{children:"client_john"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["In the database for our app, we have a table called ",(0,a.jsx)(n.code,{children:"FORM_LAYOUT"})," that holds configuration for how forms are laid out, which is always different for each client. One day, somebody makes a mistake and does a Liquibase change script to update ",(0,a.jsx)(n.code,{children:"FORM_LAYOUT"})," for Jane, but accidentally uses the ",(0,a.jsx)(n.code,{children:"core"})," context. It slips through code review and torpedoes all other client's form layout configs."]}),"\n",(0,a.jsx)(n.p,{children:"We want to stop this happening again at the source, so let's see if we can do it with a lint rule."}),"\n",(0,a.jsx)(n.h2,{id:"writing-the-rule",children:"Writing the rule"}),"\n",(0,a.jsx)(n.p,{children:"There are three interfaces you could implement when writing a custom rule in Java; which you use depends on what level you want to work at."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"https://github.com/liquibase-linter/liquibase-linter/blob/main/src/main/java/io/github/liquibaselinter/config/rules/ChangeRule.java",children:"ChangeRule"})," for linting each individual change, useful when you want to prevent issues with the content of the change itself"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"https://github.com/liquibase-linter/liquibase-linter/blob/main/src/main/java/io/github/liquibaselinter/config/rules/ChangeSetRule.java",children:"ChangeSetRule"})," for linting each changeSet, useful when you want to check things like comments and contexts, or the overall content of a changeSet e.g. when you want ensure certain changes happen together, or in isolation"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"https://github.com/liquibase-linter/liquibase-linter/blob/main/src/main/java/io/github/liquibaselinter/config/rules/ChangeLogRule.java",children:"ChangeLogRule"})," for linting each changeLog file, useful when you want to check the overall content at changeLog level - rarely used in practise"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"ChangeRule"})," interface uses generics, so you can target a specific change type e.g. ",(0,a.jsx)(n.code,{children:"implements ChangeRule<InsertDataChange>"})," for inserts, or just do ",(0,a.jsx)(n.code,{children:"implements ChangeRule<Change>"})," to catch all changes. You can also use this to lint ",(0,a.jsx)(n.a,{href:"http://www.liquibase.org/documentation/changes/custom_change.html",children:"custom changes"}),", if you have any of those in your project."]}),"\n",(0,a.jsxs)(n.p,{children:["It's worth noting that the three levels are not isolated from one another - a ",(0,a.jsx)(n.code,{children:"Change"})," has access to the ",(0,a.jsx)(n.code,{children:"ChangeSet"})," it belongs to, which in turn can access the ",(0,a.jsx)(n.code,{children:"ChangeLog"})," it belongs to, and vice versa, so you can freely traverse to get the information you need to decide if your rule is failed."]}),"\n",(0,a.jsxs)(n.p,{children:["For our ",(0,a.jsx)(n.code,{children:"FORM_LAYOUT"})," use case, it makes the most sense to lint at changeSet level. Here's the code to implement it:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'package com.fake.fancyapp.liquibase;\n\nimport liquibase.change.core.UpdateDataChange;\nimport liquibase.changelog.ChangeSet;\nimport rules.config.io.github.liquibaselinter.AbstractLintRule;\nimport rules.config.io.github.liquibaselinter.ChangeSetRule;\n\npublic class FormLayoutContextRuleImpl extends AbstractLintRule implements ChangeSetRule {\n\n  private static final String NAME = "form-layout-context";\n  private static final String MESSAGE = "FORM_LAYOUT should only ever be updated in a client-specific context!";\n\n  public FormLayoutContextRuleImpl() {\n    super(NAME, MESSAGE);\n  }\n\n  @Override\n  public boolean invalid(ChangeSet changeSet) {\n    return isForFormLayout(changeSet) && isCoreContext(changeSet);\n  }\n\n  private boolean isForFormLayout(ChangeSet changeSet) {\n    return changeSet\n      .getChanges()\n      .stream()\n      .anyMatch(\n        change -> change instanceof UpdateDataChange && "FORM_LAYOUT".equals(((UpdateDataChange) change).getTableName())\n      );\n  }\n\n  private boolean isCoreContext(ChangeSet changeSet) {\n    return changeSet.getContextFilter().getContexts().stream().anyMatch("core"::equals);\n  }\n}\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Some notes about how we've done this:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["We've extended the ",(0,a.jsx)(n.code,{children:"AbstractLintRule"})," class, which saves us fussing about a lot of boilerplate ourselves. We just need to pass our rule name (i.e. the key uses in the ",(0,a.jsx)(n.a,{href:"/liquibase-linter/docs/rules/",children:"rules config"}),") and the failure message"]}),"\n",(0,a.jsxs)(n.li,{children:["The key method we need to implement ourselves is ",(0,a.jsx)(n.code,{children:"invalid"})," - this accepts a ",(0,a.jsxs)(n.a,{href:"https://github.com/liquibase/liquibase/blob/main/liquibase-core/src/main/java/liquibase/changelog/ChangeSet.java",children:["Liquibase ",(0,a.jsx)(n.code,{children:"ChangeSet"})]})," and should return true if the rule has ",(0,a.jsx)(n.em,{children:"failed"})," - in this case it will do so if any of the changes are an update on the ",(0,a.jsx)(n.code,{children:"FORM_LAYOUT"})," table ",(0,a.jsx)(n.em,{children:"and"})," the ",(0,a.jsx)(n.code,{children:"core"})," context is used"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["All the core rules are implemented in this way as well, so if you're not sure how best to hook something up you might try looking in the source at ",(0,a.jsx)(n.a,{href:"https://github.com/liquibase-linter/liquibase-linter/tree/main/src/main/java/io/github/liquibaselinter/config/rules/core",children:"some existing core rules"})," that do something similar"]}),"\n",(0,a.jsx)(n.h2,{id:"making-the-rule-discoverable",children:"Making the rule discoverable"}),"\n",(0,a.jsxs)(n.p,{children:["Now, our class above should go into a new Maven project that depends on both ",(0,a.jsx)(n.code,{children:"liquibase-linter"})," and ",(0,a.jsx)(n.code,{children:"liquibase"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The class existing isn't quite enough on its own; we need to tell Liquibase Linter that it's there. For this we are using the ",(0,a.jsx)(n.a,{href:"https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html",children:"Service Provider Interface"})," pattern - this is natively supported in Java and for use cases like this is preferable to powerful-but-heavy classpath scanning approaches like the one used by Spring."]}),"\n",(0,a.jsx)(n.p,{children:"In our newly-created project, we'll create a new file at:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"src/main/resources/META-INF/services/rules.config.io.github.liquibaselinter.ChangeSetRule"})}),"\n",(0,a.jsx)(n.p,{children:"And in the file, we'll write:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.code,{children:"com.fake.fancyapp.liquibase.FormLayoutContextRuleImpl"})}),"\n",(0,a.jsx)(n.h2,{id:"configuring-the-rule",children:"Configuring the rule"}),"\n",(0,a.jsxs)(n.p,{children:["In the project where our scripts live, we'll add a dependency on our rules project to ",(0,a.jsx)(n.code,{children:"liquibase-maven-plugin"}),", in much the same way that we ",(0,a.jsxs)(n.a,{href:"/liquibase-linter/docs/configure",children:["added a dependency for ",(0,a.jsx)(n.code,{children:"liquibase-linter"})," originally"]}),":\nSo for our example custom rules project ",(0,a.jsx)(n.code,{children:"wcg-liquibase-linter"})," we would have the following dependency."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<plugin>\n  <groupId>org.liquibase</groupId>\n  <artifactId>liquibase-maven-plugin</artifactId>\n  <configuration>...</configuration>\n  <dependencies>\n    <dependency>\n      <groupId>io.github.liquibase-linter</groupId>\n      <artifactId>liquibase-parser-extension</artifactId>\n    </dependency>\n    <dependency>\n      <groupId>com.fake.fancyapp</groupId>\n      <artifactId>liquibase-linter-rules</artifactId>\n      <version>0.1.0</version>\n    </dependency>\n  </dependencies>\n  <executions>...</executions>\n</plugin>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Then all we need is to ",(0,a.jsx)(n.a,{href:"/liquibase-linter/docs/rules/",children:"configure the rule as normal"})," in ",(0,a.jsx)(n.code,{children:"lqlint.json"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}}}]);